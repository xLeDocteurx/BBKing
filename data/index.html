<head>
  <title>BBKing</title>
  <link rel="icon" href="data:," />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="semantic/dist/semantic.min.js"></script> -->

  <script src="https://cdn.tailwindcss.com"></script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1
        v-if="wsStatus"
        @click="($event)=>{sendMessageViaWebsocket('toggle');}"
        style="text-align: center"
        class="text-3xl font-bold underline"
      >
        BBKing
      </h1>
    </header>
    <div class="h-full p-4 grid grid-cols-4 grid-rows-3 gap-4">
      <div
        class="row-start-1 row-end-3 col-start-1 col-end-2 border border-solid p-4"
      >
        <h2 class="font-bold">Controls</h2>
        <div class="divide-y divide-dotted">
          <div class="flex rounded-lg shadow-sm my-2">
            <button
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
              @click="($event)=>{saveSong();}"
            >
              <i class="fas fa-save"></i>
            </button>
            <button
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
              @click="($event)=>{stop();}"
            >
              <i class="fas fa-stop"></i>
            </button>
            <button
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
              @click="($event)=>{play();}"
            >
              <i class="fas fa-play"></i>
            </button>
          </div>
          <div class="flex rounded-lg shadow-sm my-2">
            <!-- <i class="fas fa-music"></i> -->
            <!-- :class="{ 'btn-primary': machineState.currentModeIndex == 2, 'btn-outline-primary': !machineState.currentModeIndex == 2}" -->
            <button
              disabled
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
              @click="() => {updateCurrentMode(0);}"
            >
              FX
            </button>
            <button
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {updateCurrentMode(0);}"
              type="button"
              :class="{ 'btn-primary': machineState.currentModeIndex == 0, 'btn-outline-primary': !machineState.currentModeIndex == 0}"
            >
              <i class="fas fa-guitar"></i>
            </button>
            <button
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {updateCurrentMode(1);}"
              type="button"
              :class="{ 'btn-primary': machineState.currentModeIndex == 1, 'btn-outline-primary': !machineState.currentModeIndex == 1}"
            >
              <i class="fas fa-shoe-prints"></i>
            </button>
          </div>
          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
            >
              <i class="fas fa-vial"></i>
            </button>
            <button
              disabled
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
            >
              <i class="fas fa-volume-up"></i>
            </button>
            <button
              disabled
              class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              type="button"
            >
              <i class="fas fa-volume-mute"></i>
            </button>
          </div>
        </div>

        <h2 class="font-bold">Master</h2>
        <div class="divide-y divide-dotted">
          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              gain
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              min="0"
              max="5"
              step="0.25"
              :value="machineState.masterGain"
              @change="($event)=>{updateMasterGain($event);}"
            />
          </div>
        </div>

        <h2 class="font-bold">Song</h2>
        <div class="divide-y divide-dotted">
          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              song
            </button>
            <input
              type="text"
              class="w-full py-2 px-3"
              :value="machineState.songName"
              @change="($event)=>{updateSongName($event);}"
            />
            <button
              :disabled="machineState.currentSongIndex == 0"
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {httpAction('UPDATECURRENTSONGINDEX', machineState.currentSongIndex - 1)}"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <button
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {httpAction('CREATESONGATINDEX', machineState.currentSongIndex + 1)}"
            >
              <i class="fas fa-plus"></i>
            </button>
            <button
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {httpAction('DELETESONGATINDEX', machineState.currentSongIndex)}"
            >
              <i class="fas fa-trash"></i>
            </button>
            <button
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="() => {httpAction('UPDATECURRENTSONGINDEX', machineState.currentSongIndex + 1)}"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              bpm
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              step="1"
              :value="machineState.songTempo"
              @change="($event)=>{updateTempo($event);}"
            />
          </div>
        </div>

        <h2 class="font-bold">Part</h2>
        <div class="divide-y divide-dotted">
          <div class="flex rounded-lg shadow-sm my-2">
            <!-- v-if="machineState.currentPartIndex > 0" -->
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              part
            </button>
            <input
              disabled
              class="w-full py-2 px-3"
              type="text"
              :value="machineState.currentPartIndex + 1"
            />
            <button
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="($event)=>{loadPreviousPart();}"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <button
              :disabled="!(machineState.currentPartIndex >= machineState.parts.length -1)"
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="($event)=>{createNextPart();}"
            >
              <i class="fas fa-plus"></i>
            </button>
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              <i class="fas fa-trash"></i>
            </button>
            <button
              :disabled="!(machineState.currentPartIndex < machineState.parts.length -1)"
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              @click="($event)=>{loadNextPart();}"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div class="card-text">
          <div class="btn-group w-100 mb"></div>
        </div>
      </div>
      <div
        class="row-start-1 row-end-3 col-start-2 col-end-3 border border-solid p-4"
      >
        <div class="font-bold">Commons</div>

        <div class="divide-y divide-dotted">
          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              Pitch/Sustain
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              min="-48"
              max="48"
              step="1"
              id="pitchSustainRange"
              :value="getCommonsControlValues().pitch"
              @change="($event)=>{updatePitch($event);}"
            />
          </div>

          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              Volume
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              min="0"
              max="1"
              step="0.025"
              id="volumeRange"
              :value="getCommonsControlValues().volume"
              @change="($event)=>{updateVolume($event);}"
            />
          </div>

          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              Start
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              min="0"
              max="1"
              step="0.0025"
              id="startPositionRange"
              :value="getCommonsControlValues().startPosition"
              @change="($event)=>{updateStartPosition($event);}"
            />
          </div>

          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              End
            </button>
            <input
              class="w-full py-2 px-3"
              type="number"
              min="0"
              max="1"
              step="0.0025"
              id="endPositionRange"
              :value="getCommonsControlValues().endPosition"
              @change="($event)=>{updateEndPosition($event);}"
            />
          </div>

          <div class="flex rounded-lg shadow-sm my-2">
            <button
              disabled
              type="button"
              class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            >
              IsReverse
            </button>
            <!-- class="w-full py-2 px-3" -->
            <input
              type="checkbox"
              role="switch"
              id="isReverseSwitch"
              :value="getCommonsControlValues().isReverse"
              @change="($event)=>{updateIsReverse($event);}"
            />
          </div>
        </div>
      </div>
      <div class="row-start-1 row-end-3 col-start-3 col-end-4">
        <div class="border border-solid p-4 h-1/2">
          <h2 class="font-bold">Modulation</h2>
          <div>xxx</div>
        </div>
        <div class="border border-solid p-4 h-1/2">
          <h2 class="font-bold">Filter</h2>
          <div>xxx</div>
        </div>
      </div>
      <div
        class="row-start-1 row-end-3 col-start-4 col-end-5 border border-solid p-4"
      >
        <h2 class="font-bold">Effects</h2>
        <div>xxx</div>
      </div>
      <div
        class="row-start-3 row-end-4 col-start-1 col-end-5 border border-solid p-4"
      >
        <h2 class="font-bold">Instrument</h2>
        <div class="flex rounded-lg shadow-sm my-2">
          <button
            disabled
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
          >
            sample
          </button>
          <select class="w-full py-2 px-3">
            <option
              v-for="(s, s_index) in wavFilesList"
              @click="($event) => updateSelectedInstrumentSample(s_index)"
              :value="s_index"
              :selected="machineState.instruments[machineState.currentPartInstrumentIndex].sample.filePath == s"
            >
              {{s}}
            </option>
          </select>
          <button
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            @click="($event)=>{getPreviousSample();}"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <button
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            @click="($event)=>{getNextSample();}"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div>
          <button
            :disabled="machineState.parts[machineState.currentPartIndex].staves<2"
            @click="($event) => {updateStaveNumber(machineState.parts[machineState.currentPartIndex].staves-1)}"
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
          >
            <i class="fas fa-minus"></i>
          </button>
          <button
            v-for="n in machineState.parts[machineState.currentPartIndex].staves"
            @click="($event) => {selectStave(n-1);}"
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
            :class="{ 'border-gray-800': machineState.currentStaveIndex == n-1, 'text-gray-200': machineState.currentStaveIndex == n-1, 'bg-black': machineState.currentStaveIndex == n-1 }"
          >
            <b>{{n}}</b>
          </button>
          <button
            @click="($event) => {updateStaveNumber(machineState.parts[machineState.currentPartIndex].staves+1)}"
            type="button"
            class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div>
          <div>
            <!-- <button
                disabled
                type="button"
                class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              >
                <i class="fas fa-hand-spock"></i>
              </button>
              <button
                disabled
                type="button"
                class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
              >
                <i class="fas fa-keyboard"></i>
              </button> -->
          </div>
          <div class="relative h-1/2">
            <div
              class="absolute bottom-0 inset-x-0 h-1/2 flex place-content-center"
            >
              <button
                v-for="n in 16"
                @click="($event)=>{toggleInstrumentStep(n-1);}"
                type="button"
                style="width: 6vw"
                class="py-2 px-3 w-full inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                :class="{ 'border-gray-800': isStepActive(n-1), 'text-gray-200': isStepActive(n-1), 'bg-black': isStepActive(n-1) }"
                :disabled="!isStepClickable(n-1)"
              >
                <b>{{n}}</b>
              </button>
            </div>
            <div
              class="absolute bottom-1/3 inset-x-0 h-1/2 flex place-content-between"
            >
              <div class="flex" style="width: 3.5vw"></div>

              <div class="flex">
                <button
                  @click="($event)=>{selectInstrument(0);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 0, 'text-gray-200': machineState.currentPartInstrumentIndex == 0, 'bg-black': machineState.currentPartInstrumentIndex == 0 }"
                >
                  D1
                </button>
                <button
                  @click="($event)=>{selectInstrument(1);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 1, 'text-gray-200': machineState.currentPartInstrumentIndex == 1, 'bg-black': machineState.currentPartInstrumentIndex == 1 }"
                >
                  D2
                </button>
              </div>
              <div class="flex">
                <button
                  @click="($event)=>{selectInstrument(2);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 2, 'text-gray-200': machineState.currentPartInstrumentIndex == 2, 'bg-black': machineState.currentPartInstrumentIndex == 2 }"
                >
                  D3
                </button>
                <button
                  @click="($event)=>{selectInstrument(3);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 3, 'text-gray-200': machineState.currentPartInstrumentIndex == 3, 'bg-black': machineState.currentPartInstrumentIndex == 3 }"
                >
                  D4
                </button>
                <button
                  @click="($event)=>{selectInstrument(4);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 4, 'text-gray-200': machineState.currentPartInstrumentIndex == 4, 'bg-black': machineState.currentPartInstrumentIndex == 4 }"
                >
                  D5
                </button>
              </div>
              <div class="flex">
                <button
                  @click="($event)=>{selectInstrument(5);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 5, 'text-gray-200': machineState.currentPartInstrumentIndex == 5, 'bg-black': machineState.currentPartInstrumentIndex == 5 }"
                >
                  D6
                </button>
                <button
                  @click="($event)=>{selectInstrument(6);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 6, 'text-gray-200': machineState.currentPartInstrumentIndex == 6, 'bg-black': machineState.currentPartInstrumentIndex == 6 }"
                >
                  D7
                </button>
              </div>
              <div class="flex">
                <button
                  @click="($event)=>{selectInstrument(7);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 7, 'text-gray-200': machineState.currentPartInstrumentIndex == 7, 'bg-black': machineState.currentPartInstrumentIndex == 7 }"
                >
                  D8
                </button>
                <button
                  @click="($event)=>{selectInstrument(8);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 8, 'text-gray-200': machineState.currentPartInstrumentIndex == 8, 'bg-black': machineState.currentPartInstrumentIndex == 8 }"
                >
                  D9
                </button>
                <button
                  @click="($event)=>{selectInstrument(9);}"
                  type="button"
                  style="width: 6vw"
                  class="py-2 px-3 inline-flex justify-center items-center gap-2 -ms-px first:rounded-s-lg first:ms-0 last:rounded-e-lg text-sm font-medium focus:z-10 border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none"
                  :class="{ 'border-gray-800': machineState.currentPartInstrumentIndex == 9, 'text-gray-200': machineState.currentPartInstrumentIndex == 9, 'bg-black': machineState.currentPartInstrumentIndex == 9 }"
                >
                  D10
                </button>
              </div>

              <div class="flex" style="width: 3.5vw"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function httpGet(path) {
      const response = await fetch(`${path}`);
      const json = await response.json();
      console.log("httpGet res : ", json);
      return json;
    }
    function resizeArray(arr, newSize, defaultValue) {
      return [
        ...arr,
        ...Array(Math.max(newSize - arr.length, 0)).fill(defaultValue),
      ];
    }

    const wsUri = `ws://${window.location.host}/ws`;

    // const allPromises = Promise.all([httpGet("/state")]);

    const { createApp, ref, reactive } = Vue;

    // allPromises.then((allPromisesRet) => {
    createApp({
      setup() {
        const wsStatus = ref(false);

        const machineState = ref({
          masterGain: 0,
          currentModeIndex: 0,
          currentSelectedStepIndex: 0,
          currentSongIndex: 0,
          songName: "NULL song",
          songTempo: 666,
          instruments: [
            {
              sample: {
                filePath: "/data/kick.wav",
                isMono: true,
                fileSize: 9502,
              },
              isSolo: false,
              isMuted: false,
              volume: 0.5,
              pitch: 0,
            },
          ],
          currentPartIndex: 0,
          currentPartInstrumentIndex: 0,
          currentStaveIndex: 0,
          currentOctaveIndex: 0,
          parts: [
            {
              staves: 1,
              steps: [
                [
                  {
                    instrumentIndex: 0,
                    pitch: 0,
                    volume: 0.9,
                  },
                ],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
              ],
            },
          ],
        });

        const wavFilesList = ref([]);

        const ws = ref(null);

        const httpAction = async function (actionName, actionParameters) {
          // console.log(
          //   "httpAction actionName : ",
          //   actionName,
          //   " / actionParameters : ",
          //   actionParameters
          // );
          const response = await fetch(`/action`, {
            method: "POST",
            body: `${actionName}@${
              // typeof actionParameters == "string"
              //   ? JSON.stringify(actionParameters)
              //   : actionParameters
              JSON.stringify(actionParameters)
            }`,
          });
          // const json = await response.json();
          const text = await response.text();
          // console.log("httpAction res : ", json);
          console.log("httpAction res : ", text);
          // TODO : temporary solution for pongs
          sendMessageViaWebsocket("toggle");
          // return json;
        };
        const updateMachineStateRef = async function () {
          const response = await fetch(`/state`);
          const json = await response.json();
          console.log("updateMachineStateRef httpGet res : ", json);
          machineState.value = json;
        };
        const updateWavFilesListRef = async function () {
          const response = await fetch(`/wavFiles`);
          const json = await response.json();
          console.log("updateWavFilesListRef httpGet res : ", json);
          wavFilesList.value = json;
        };
        const connectToWebsocket = function () {
          ws.value = new WebSocket(wsUri);

          ws.value.onopen = () => {
            console.log("connected");
            wsStatus.value = true;
          };

          ws.value.onclose = () => {
            console.log("disconnected");
            wsStatus.value = false;
          };

          ws.value.onmessage = (event) => {
            const message = event.data;
            if (message === "pong") {
              console.log("Pong received !");
            } else {
              console.log("Message received :", message);
              // console.log("Message received as json :", JSON.parse(message));
              // machineState.value = message;
              updateMachineStateRef();
              // updateWavFilesListRef();
            }
          };
        };

        const sendMessageViaWebsocket = function (message) {
          if (!!ws && ws.value.readyState === WebSocket.OPEN) {
            ws.value.send(message);
          } else {
            console.log("WebSocket non connected !");
          }
        };

        // TODO : Refactor to prevent code duplication ( returns and var initialization outside the if statement )
        const getCommonsControlValues = function () {
          if (machineState.value.currentModeIndex == 0) {
            const obj =
              machineState.value.instruments[
                machineState.value.currentPartInstrumentIndex
              ];
            return {
              volume: obj.volume,
              pitch: obj.pitch,
              startPosition: obj.startPosition,
              endPosition: obj.endPosition,
              isReverse: obj.isReverse,
            };
          } else if (machineState.value.currentModeIndex == 1) {
            // console.log(
            //   machineState.value.currentSelectedStepIndex + 16 * machineState.value.currentStaveIndex,
            //   " / ",
            //   machineState.value.parts[
            //     machineState.value.currentPartIndex
            //   ].steps[
            //     machineState.value.currentSelectedStepIndex +
            //       16 * machineState.value.currentStaveIndex
            //   ].find(
            //     (st) =>
            //       st.instrumentIndex ==
            //       machineState.value.currentPartInstrumentIndex
            //   )
            // );

            // console.log("-----");
            // console.log(
            //   "before find : machineState.value.currentSelectedStepIndex=",
            //   machineState.value.currentSelectedStepIndex,
            //   " / machineState.value.currentStaveIndex=",
            //   machineState.value.currentStaveIndex
            // );
            // console.log(
            //   "machineState.value.currentSelectedStepIndex + 16 * machineState.value.currentStaveIndex : ",
            //   machineState.value.currentSelectedStepIndex +
            //     16 * machineState.value.currentStaveIndex
            // );
            const obj = machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[
              machineState.value.currentSelectedStepIndex
              //  + 16 * machineState.value.currentStaveIndex
            ].find(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
            return {
              volume: obj.volume,
              pitch: obj.pitch,
              startPosition: obj.startPosition,
              endPosition: obj.endPosition,
              isReverse: obj.isReverse,
            };
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };
        const isStepClickable = function (stepIndex) {
          if (machineState.value.currentModeIndex == 0) {
            return true;
          } else if (machineState.value.currentModeIndex == 1) {
            return machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[stepIndex + 16 * machineState.value.currentStaveIndex].some(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };
        const isStepActive = function (stepIndex) {
          if (machineState.value.currentModeIndex == 0) {
            return machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[stepIndex + 16 * machineState.value.currentStaveIndex].some(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
          } else if (machineState.value.currentModeIndex == 1) {
            return stepIndex + 16 * machineState.value.currentStaveIndex == machineState.value.currentSelectedStepIndex;
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };

        const saveSong = function (modeIndex) {
          // TODO : try it everywhere for actions wiuth no arguments
          // httpAction("SAVESONG");
          httpAction("SAVESONG", {});
        };
        const updateMasterGain = function (event) {
          httpAction("UPDATEMASTERGAIN", Number(event.target.value));
        };
        const updateCurrentMode = function (modeIndex) {
          httpAction("UPDATECURRENTMODE", modeIndex);
        };
        const updateSongName = function (event) {
          httpAction("UPDATESONGNAME", event.target.value);
        };
        const updateTempo = function (event) {
          httpAction("UPDATETEMPO", Number(event.target.value));
        };
        const play = function () {
          httpAction("PLAY", {});
        };
        const stop = function () {
          httpAction("STOP", {});
        };
        const loadPreviousPart = function () {
          httpAction("SELECTPART", machineState.value.currentPartIndex - 1);
        };
        const loadNextPart = function () {
          httpAction("SELECTPART", machineState.value.currentPartIndex + 1);
        };
        const createNextPart = function () {
          httpAction("CREATEPART", {});
        };
        const updateStaveNumber = function (staveNumber) {
          httpAction("UPDATESTAVENUMBER", staveNumber);
        };
        const selectStave = function (staveIndex) {
          httpAction("SELECTSTAVE", staveIndex);
        };
        const selectInstrument = function (instrumentIndex) {
          httpAction("SELECTINSTRUMENT", instrumentIndex);
        };
        const getPreviousSample = function () {
          const currentFilePath =
            machineState.value.instruments[
              machineState.value.currentPartInstrumentIndex
            ].sample.filePath;
          const currentFileIndex = wavFilesList.value.indexOf(currentFilePath);
          console.log("bouya", currentFileIndex);
          if (currentFileIndex - 1 >= 0) {
            console.log("kasha");
            updateSelectedInstrumentSample(currentFileIndex - 1);
          }
        };
        const getNextSample = function () {
          const currentFilePath =
            machineState.value.instruments[
              machineState.value.currentPartInstrumentIndex
            ].sample.filePath;
          const currentFileIndex = wavFilesList.value.indexOf(currentFilePath);
          console.log("bouya", currentFileIndex, wavFilesList.value.length);
          if (currentFileIndex + 1 <= wavFilesList.value.length - 1) {
            console.log("kasha");
            updateSelectedInstrumentSample(currentFileIndex + 1);
          }
        };
        const updateSelectedInstrumentSample = function (sampleIndex) {
          httpAction("UPDATESELECTEDINSTRUMENTSAMPLE", sampleIndex);
        };
        const toggleInstrumentStep = function (stepIndex) {
          console.log("toggleInstrumentStep stepIndex : ", stepIndex);
          const stepIndexToUpdate =
            stepIndex + 16 * machineState.value.currentStaveIndex;
          if (machineState.value.currentModeIndex == 0) {
            httpAction("TOGGLEINSTRUMENTSTEP", stepIndexToUpdate);
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction("UPDATECURRENTSELECTEDSTEP", stepIndexToUpdate);
          }
        };

        const updateVolume = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEVOLUME",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPVOLUME",
              Number(event.target.value)
            );
          }
        };

        const updatePitch = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEPITCH",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPPITCH",
              Number(event.target.value)
            );
          }
        };

        const updateStartPosition = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTARTPOSITION",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPSTARTPOSITION",
              Number(event.target.value)
            );
          }
        };

        const updateEndPosition = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEENDPOSITION",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPENDPOSITION",
              Number(event.target.value)
            );
          }
        };

        const updateIsReverse = function (event) {
          // console.log(
          //   "updateIsReverse event.target.checked : ",
          //   event.target.checked
          // );
          const isChecked = event.target.checked ? 1 : 0;
          if (machineState.value.currentModeIndex == 0) {
            httpAction("UPDATEINSTRUMENTSAMPLEISREVERSE", isChecked);
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction("UPDATEINSTRUMENTSAMPLESTEPISREVERSE", isChecked);
          }
        };

        updateMachineStateRef().then((_) => {
          connectToWebsocket();
        });

        updateWavFilesListRef();

        return {
          wsStatus,
          machineState,
          wavFilesList,
          httpAction,
          connectToWebsocket,
          sendMessageViaWebsocket,
          saveSong,
          updateMasterGain,
          updateCurrentMode,
          updateSongName,
          updateTempo,
          play,
          stop,
          loadPreviousPart,
          loadNextPart,
          createNextPart,
          updateStaveNumber,
          selectStave,
          selectInstrument,
          getPreviousSample,
          getNextSample,
          updateSelectedInstrumentSample,
          getCommonsControlValues,
          isStepClickable,
          isStepActive,
          toggleInstrumentStep,
          updateTempo,
          updateVolume,
          updatePitch,
          updateStartPosition,
          updateEndPosition,
          updateIsReverse,
        };
      },
    }).mount("#app");
    // });
  </script>
</body>
