<head>
  <title>BBKing</title>
  <link rel="icon" href="data:," />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sketchy/bootstrap.min.css"
    integrity="sha384-RxqHG2ilm4r6aFRpGmBbGTjsqwfqHOKy1ArsMhHusnRO47jcGqpIQqlQK/kmGy9R"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
    integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
  <div id="app">
    <div class="topnav">
      <button id="connect" @click="($event)=>{connectToWebsocket();}">
        Connecter
      </button>
      <button
        id="send-ping"
        @click="($event)=>{sendMessageViaWebsocket('ping');}"
      >
        Envoyer un ping
      </button>
      <span id="status">{{wsStatus}}</span>
      <h1 class="text-center">BBKing</h1>
    </div>
    <div class="container-fluid">
      <div class="row pb-4">
        <div class="col">
          <div class="card border-primary h-100">
            <div class="card-header">
              <div class="input-group">
                <input
                  disabled
                  type="text"
                  class="form-control"
                  :value="songName"
                  @change="($event)=>{updateSongName($event);}"
                />
                <button
                  v-if="currentPartIndex > 0"
                  type="button"
                  class="btn btn-outline-primary"
                  @click="($event)=>{loadPreviousPart();}"
                >
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span class="input-group-text"
                  >Part : {{ currentPartIndex + 1 }}</span
                >
                <button
                  v-if="currentPartIndex < parts.length -1"
                  type="button"
                  class="btn btn-outline-primary"
                  @click="($event)=>{loadNextPart();}"
                >
                  <i class="fas fa-chevron-right"></i>
                </button>
                <button
                  v-if="currentPartIndex >= parts.length -1"
                  type="button"
                  class="btn btn-outline-primary"
                  @click="($event)=>{createNextPart();}"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="input-group">
                <input
                  type="number"
                  step="1"
                  class="form-control"
                  :value="songTempo"
                  @change="($event)=>{updateTempo($event);}"
                />
                <span class="input-group-text">bpm</span>
              </div>
            </div>
            <div class="card-footer">
              <div class="card-text">
                <div class="btn-group w-100 mb-2" role="group">
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-record-vinyl"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary w-25"
                    @click="($event)=>{play();}"
                  >
                    <i class="fas fa-play"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary w-25"
                    @click="($event)=>{stop();}"
                  >
                    <i class="fas fa-stop"></i>
                  </button>
                </div>
              </div>
              <div class="card-text">
                <div class="btn-group w-100 mb-2" role="group">
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-music"></i>
                  </button>
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-guitar"></i>
                  </button>
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-shoe-prints"></i>
                  </button>
                </div>
              </div>
              <div class="card-text">
                <div class="btn-group w-100 mb" role="group">
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-vial"></i>
                  </button>
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <button
                    disabled
                    type="button"
                    class="btn btn-outline-primary w-25"
                  >
                    <i class="fas fa-volume-mute"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card border-primary h-100">
            <div class="card-header">Common / Instrument</div>
            <div class="card-body">
              <div class="card-text">
                <form>
                  <fieldset>
                    <label for="pitchSustainRange" class="form-label"
                      >Pitch / Sustain :</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      min="-48"
                      max="48"
                      step="1"
                      id="pitchSustainRange"
                      :value="getCurrentInstrumentSample().pitch"
                      @change="($event)=>{updateInstrumentSamplePitch($event);}"
                    />
                    <label for="volumeRange" class="form-label">Volume :</label>
                    <input
                      type="range"
                      class="form-range"
                      min="0"
                      max="1"
                      step="0.0025"
                      id="volumeRange"
                      :value="getCurrentInstrumentSample().volume"
                      @change="($event)=>{updateInstrumentSampleVolume($event);}"
                    />
                  </fieldset>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="row pb-2 h-50">
            <div class="col">
              <div class="card border-primary h-100">
                <div class="card-header">Modulation</div>
                <div class="card-body">
                  <div class="card-text"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="row pt-2 h-50">
            <div class="col">
              <div class="card border-primary h-100">
                <div class="card-header">Filter</div>
                <div class="card-body">
                  <div class="card-text"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card border-primary h-100">
            <div class="card-header">Effects</div>
            <div class="card-body">
              <div class="card-text"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card border-primary h-100">
            <div class="card-header">
              <div
                class="btn-group"
                role="group"
                aria-label="Button group with nested dropdown"
              >
                <button type="button" class="btn btn-outline-primary">
                  {{getCurrentInstrumentSample().filePath}}
                </button>
                <div class="btn-group" role="group">
                  <button
                    id="btnGroupDrop1"
                    type="button"
                    class="btn btn-outline-primary dropdown-toggle"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                  ></button>
                  <div
                    class="dropdown-menu"
                    aria-labelledby="btnGroupDrop1"
                    style=""
                  >
                    <a v-for="s in samples" class="dropdown-item" href="#"
                      >{{s.filePath}}</a
                    >
                  </div>
                </div>
              </div>
              <!-- <div class="btn-group" role="group">
                <button disabled type="button" class="btn btn-outline-primary">
                  <i class="fas fa-hand-spock"></i>
                </button>
                <button disabled type="button" class="btn btn-outline-primary">
                  <i class="fas fa-keyboard"></i>
                </button>
              </div> -->
              <div class="btn-group" role="group">
                <button
                  v-if="parts[currentPartIndex].staves>1"
                  @click="($event) => {updateStaveNumber(parts[currentPartIndex].staves-1)}"
                  type="button"
                  class="btn btn-outline-primary"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <button
                  v-for="n in parts[currentPartIndex].staves"
                  @click="($event) => {selectStave(n-1);}"
                  type="button"
                  class="btn"
                  :class="{ 'btn-primary': currentStaveIndex == n-1, 'btn-outline-primary': !(currentStaveIndex == n-1)}"
                >
                  <b>{{n}}</b>
                </button>
                <button
                  @click="($event) => {updateStaveNumber(parts[currentPartIndex].staves+1)}"
                  type="button"
                  class="btn btn-outline-primary"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="card-text py-2">
                <div
                  class="input-group-lg d-flex flex-row justify-content-between"
                  role="group"
                >
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(0);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 0}"
                  >
                    D1
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(1);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 1}"
                  >
                    D2
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(2);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 2}"
                  >
                    D3
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(3);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 3}"
                  >
                    D4
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(4);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 4}"
                  >
                    D5
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(5);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 5}"
                  >
                    D6
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(6);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 6}"
                  >
                    D7
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    disabled
                    @click="($event)=>{selectInstrument(7);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 7}"
                  >
                    Si
                  </button>
                  <button
                    disabled
                    @click="($event)=>{selectInstrument(8);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 8}"
                  >
                    Sa
                  </button>
                  <button
                    disabled
                    @click="($event)=>{selectInstrument(9);}"
                    type="button"
                    class="btn btn-outline-primary"
                    :class="{ 'btn-primary': currentPartInstrumentIndex == 9}"
                  >
                    Sy
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                </div>
              </div>
              <div class="card-text py-2">
                <div
                  class="input-group-lg d-flex flex-row justify-content-around"
                  role="group"
                >
                  <button
                    v-for="n in 16"
                    @click="($event)=>{toggleInstrumentStep(n-1);}"
                    type="button"
                    class="btn"
                    :class="{ 'btn-primary': isStepActive(n-1), 'btn-outline-primary': !isStepActive(n-1)}"
                  >
                    <b>{{n}}</b>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function httpGet(path) {
      const response = await fetch(`${path}`);
      const json = await response.json();
      console.log("httpGet res : ", json);
      return json;
    }
    async function httpAction(actionName, actionParameters) {
      const response = await fetch(`/action`, {
        method: "POST",
        body: `${actionName}@${JSON.stringify(actionParameters)}`,
      });
      const json = await response.json();
      console.log("httpAction res : ", json);
      return json;
    }
    function resizeArray(arr, newSize, defaultValue) {
      return [
        ...arr,
        ...Array(Math.max(newSize - arr.length, 0)).fill(defaultValue),
      ];
    }

    const wsUri = `ws://${window.location.host}/ws`;

    const allPromises = Promise.all([httpGet("/state")]);

    const { createApp, ref, reactive } = Vue;

    allPromises.then((allPromisesRet) => {
      createApp({
        setup() {
          const songIndex = ref(allPromisesRet[0].currentSongIndex);
          const songName = ref(allPromisesRet[0].songName);
          const songTempo = ref(allPromisesRet[0].songTempo);

          const currentPartIndex = ref(allPromisesRet[0].currentPartIndex);
          const currentPartInstrumentIndex = ref(
            allPromisesRet[0].currentPartInstrumentIndex
          );
          const currentStaveIndex = ref(allPromisesRet[0].currentStaveIndex);
          console.log("currentStaveIndex : ", currentStaveIndex);

          const drumRackSampleFileRefIndex1 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex1
          );
          const drumRackSampleFileRefIndex2 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex2
          );
          const drumRackSampleFileRefIndex3 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex3
          );
          const drumRackSampleFileRefIndex4 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex4
          );
          const drumRackSampleFileRefIndex5 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex5
          );
          const drumRackSampleFileRefIndex6 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex6
          );
          const drumRackSampleFileRefIndex7 = ref(
            allPromisesRet[0].drumRackSampleFileRefIndex7
          );
          const samples = ref(allPromisesRet[0].samples);
          const parts = ref(allPromisesRet[0].parts);

          const wsStatus = ref("Disconnected");

          const ws = ref(null);

          const connectToWebsocket = function () {
            ws.value = new WebSocket(wsUri);

            ws.value.onopen = () => {
              console.log("connected");
              wsStatus.value = "Connected";
            };

            ws.value.onclose = () => {
              console.log("disconnected");
              wsStatus.value = "Disconnected";
            };

            ws.value.onmessage = (event) => {
              const message = event.data;
              if (message === "pong") {
                console.log("Pong received !");
              } else {
                console.log("Message received :", message);
              }
            };
          };

          const sendMessageViaWebsocket = function (message) {
            if (!!ws && ws.value.readyState === WebSocket.OPEN) {
              ws.value.send(message);
            } else {
              console.log("WebSocket non connected !");
            }
          };

          const updateSongName = function (event) {
            httpAction("UPDATESONGNAME", event.target.value);
            songName.value = event.target.value;
          };
          const updateTempo = function (event) {
            httpAction("UPDATETEMPO", Number(event.target.value));
            songTempo.value = event.target.value;
          };
          const play = function () {
            httpAction("PLAY", {});
          };
          const stop = function () {
            httpAction("STOP", {});
          };
          const loadPreviousPart = function () {
            httpAction("SELECTPART", currentPartIndex.value - 1);
            currentPartIndex.value -= 1;
            currentStaveIndex.value = 0;
          };
          const loadNextPart = function () {
            httpAction("SELECTPART", currentPartIndex.value + 1);
            currentPartIndex.value += 1;
            currentStaveIndex.value = 0;
          };
          const createNextPart = function () {
            httpAction("CREATEPART", {});
            parts.value.push({
              staves: 1,
              steps: [
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
              ],
            });
            currentPartIndex.value += 1;
          };
          const updateStaveNumber = function (staveNumber) {
            httpAction("UPDATESTAVENUMBER", staveNumber);
            if (currentStaveIndex.value >= staveNumber) {
              currentStaveIndex.value = staveNumber - 1;
            }
            parts.value[currentPartIndex.value].staves = staveNumber;

            parts.value[currentPartIndex.value].steps = resizeArray(
              parts.value[currentPartIndex.value].steps,
              16 * parts.value[currentPartIndex.value].staves,
              []
            );
          };
          const selectStave = function (staveIndex) {
            httpAction("SELECTSTAVE", staveIndex);
            currentStaveIndex.value = staveIndex;
          };
          const selectInstrument = function (instrumentIndex) {
            httpAction("SELECTINSTRUMENT", instrumentIndex);
            currentPartInstrumentIndex.value = instrumentIndex;
          };
          const getCurrentInstrumentSample = function () {
            return samples.value[getCurrentInstrumentSampleIndex()];
          };
          const getCurrentInstrumentSampleIndex = function () {
            let sampleIndex = 0;
            switch (currentPartInstrumentIndex.value) {
              case 0:
                sampleIndex = drumRackSampleFileRefIndex1.value;
                break;
              case 1:
                sampleIndex = drumRackSampleFileRefIndex2.value;
                break;
              case 2:
                sampleIndex = drumRackSampleFileRefIndex3.value;
                break;
              case 3:
                sampleIndex = drumRackSampleFileRefIndex4.value;
                break;
              case 4:
                sampleIndex = drumRackSampleFileRefIndex5.value;
                break;
              case 5:
                sampleIndex = drumRackSampleFileRefIndex6.value;
                break;
              case 6:
                sampleIndex = drumRackSampleFileRefIndex7.value;
                break;
            }
            return sampleIndex;
          };
          const isStepActive = function (stepIndex) {
            return parts.value[currentPartIndex.value].steps[
              stepIndex + 16 * currentStaveIndex.value
            ].some(
              (st) => st.instrumentIndex == currentPartInstrumentIndex.value
            );
          };
          const toggleInstrumentStep = function (stepIndex) {
            stepIndex += 16 * currentStaveIndex.value;
            httpAction("TOGGLEINSTRUMENTSTEP", stepIndex);
            if (isStepActive(stepIndex)) {
              parts.value[currentPartIndex.value].steps[stepIndex] =
                parts.value[currentPartIndex.value].steps[stepIndex].filter(
                  (i) => i.instrumentIndex != currentPartInstrumentIndex.value
                );
            } else {
              parts.value[currentPartIndex.value].steps[stepIndex].push({
                instrumentIndex: currentPartInstrumentIndex.value,
                pitch: 0,
                volume: 0.5,
              });
            }
          };

          const updateInstrumentSampleVolume = function (event) {
            // console.log("eventtargetvalue", event.target.value)
            httpAction(
              "UPDATEINSTRUMENTSAMPLEVOLUME",
              Number(event.target.value)
            );
            getCurrentInstrumentSample().volume = event.target.value;
          };

          const updateInstrumentSamplePitch = function (event) {
            // console.log("eventtargetvalue", event.target.value)
            httpAction(
              "UPDATEINSTRUMENTSAMPLEPITCH",
              Number(event.target.value)
            );
            getCurrentInstrumentSample().pitch = event.target.value;
          };

          connectToWebsocket();

          return {
            wsStatus,

            songIndex,
            songName,
            songTempo,
            currentPartIndex,
            currentPartInstrumentIndex,
            currentStaveIndex,
            samples,
            parts,
            connectToWebsocket,
            sendMessageViaWebsocket,
            updateSongName,
            updateTempo,
            play,
            stop,
            loadPreviousPart,
            loadNextPart,
            createNextPart,
            updateStaveNumber,
            selectStave,
            selectInstrument,
            getCurrentInstrumentSample,
            getCurrentInstrumentSampleIndex,
            isStepActive,
            toggleInstrumentStep,
            updateTempo,
            updateInstrumentSampleVolume,
            updateInstrumentSamplePitch,
          };
        },
      }).mount("#app");
    });
  </script>

  <!-- <script>
  </script> -->
</body>
