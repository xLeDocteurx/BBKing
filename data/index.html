<head>
  <title>BBKing</title>
  <link rel="icon" href="data:," />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="semantic/dist/semantic.min.js"></script> -->

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <!-- v-if="wsStatus" -->
      <h2
        @click="($event)=>{sendMessageViaWebsocket('toggle');}"
        style="text-align: center"
      >
        BBKing
      </h2>
    </header>
    <div
      style="display: flex; flex-direction: row; justify-content: space-evenly"
    >
      <div style="flex-grow: 1">
        <div>Master</div>
        <div style="display: flex; flex-direction: column">
          <div>master gain</div>
          <input
            type="number"
            min="0"
            max="5"
            step="0.25"
            :value="machineState.masterGain"
            @change="($event)=>{updateMasterGain($event);}"
          />
        </div>
        <div>Project</div>
        <div style="display: flex; flex-direction: column">
          <div>song</div>
          <button disabled type="button">
            <i class="fas fa-chevron-left"></i>
          </button>
          <input
            type="text"
            :value="machineState.songName"
            @change="($event)=>{updateSongName($event);}"
          />
          <button disabled type="button">
            <i class="fas fa-plus"></i>
          </button>
          <button disabled type="button">
            <i class="fas fa-trash"></i>
          </button>
          <button disabled type="button">
            <i class="fas fa-chevron-right"></i>
          </button>
          <div>bpm</div>
          <input
            type="number"
            step="1"
            :value="machineState.songTempo"
            @change="($event)=>{updateTempo($event);}"
          />
          <div>part</div>
          <button
            v-if="machineState.currentPartIndex > 0"
            type="button"
            @click="($event)=>{loadPreviousPart();}"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <input
            disabled
            type="text"
            :value="machineState.currentPartIndex + 1"
          />
          <button
            v-if="machineState.currentPartIndex >= machineState.parts.length -1"
            type="button"
            @click="($event)=>{createNextPart();}"
          >
            <i class="fas fa-plus"></i>
          </button>
          <button disabled type="button">
            <i class="fas fa-trash"></i>
          </button>
          <button
            v-if="machineState.currentPartIndex < machineState.parts.length -1"
            type="button"
            @click="($event)=>{loadNextPart();}"
          >
            <i class="fas fa-chevron-right"></i>
          </button>

          <div>sample</div>
          <button type="button" @click="($event)=>{getPreviousSample();}">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="nes-select">
            <select>
              <option
                v-for="(s, s_index) in wavFilesList"
                @click="($event) => updateSelectedInstrumentSample(s_index)"
                :value="s_index"
                :selected="machineState.instruments[machineState.currentPartInstrumentIndex].sample.filePath == s"
              >
                {{s}}
              </option>
            </select>
          </div>
          <button type="button" @click="($event) => getNextSample()">
            <i class="fas fa-chevron-right"></i>
          </button>

          <hr />

          <div class="card-text">
            <div class="btn-group w-100 mb-2" role="group">
              <button type="button" @click="($event)=>{saveSong();}">
                <i class="fas fa-save"></i>
              </button>
              <button type="button" @click="($event)=>{stop();}">
                <i class="fas fa-stop"></i>
              </button>
              <button type="button" @click="($event)=>{play();}">
                <i class="fas fa-play"></i>
              </button>
            </div>
          </div>
          <div class="card-text">
            <div class="btn-group w-100 mb-2" role="group">
              <!-- <i class="fas fa-music"></i> -->
              <!-- :class="{ 'btn-primary': machineState.currentModeIndex == 2, 'btn-outline-primary': !machineState.currentModeIndex == 2}" -->
              <button
                disabled
                type="button"
                @click="() => {updateCurrentMode(0);}"
              >
                FX
              </button>
              <button
                @click="() => {updateCurrentMode(0);}"
                type="button"
                :class="{ 'btn-primary': machineState.currentModeIndex == 0, 'btn-outline-primary': !machineState.currentModeIndex == 0}"
              >
                <i class="fas fa-guitar"></i>
              </button>
              <button
                @click="() => {updateCurrentMode(1);}"
                type="button"
                :class="{ 'btn-primary': machineState.currentModeIndex == 1, 'btn-outline-primary': !machineState.currentModeIndex == 1}"
              >
                <i class="fas fa-shoe-prints"></i>
              </button>
            </div>
          </div>
          <div class="card-text">
            <div class="btn-group w-100 mb" role="group">
              <!-- <button
                disabled
                type="button"
              >
                <i class="fas fa-vial"></i>
              </button> -->
              <button disabled type="button">
                <i class="fas fa-volume-up"></i>
              </button>
              <button disabled type="button">
                <i class="fas fa-volume-mute"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div style="flex-grow: 1">
        <div>Commons</div>
        <div style="display: flex; flex-direction: column">
          <label for="pitchSustainRange" class="form-label"
            >Pitch / Sustain :</label
          >
          <input
            type="number"
            min="-48"
            max="48"
            step="1"
            id="pitchSustainRange"
            :value="getCommonsControlValues().pitch"
            @change="($event)=>{updatePitch($event);}"
          />
          <label for="volumeRange" class="form-label">Volume :</label>
          <input
            type="number"
            min="0"
            max="1"
            step="0.025"
            id="volumeRange"
            :value="getCommonsControlValues().volume"
            @change="($event)=>{updateVolume($event);}"
          />

          <label for="startPositionRange" class="form-label">Start :</label>
          <input
            type="number"
            min="0"
            max="1"
            step="0.0025"
            id="startPositionRange"
            :value="getCommonsControlValues().startPosition"
            @change="($event)=>{updateStartPosition($event);}"
          />
          <label for="endPositionRange" class="form-label">End :</label>
          <input
            type="number"
            min="0"
            max="1"
            step="0.0025"
            id="endPositionRange"
            :value="getCommonsControlValues().endPosition"
            @change="($event)=>{updateEndPosition($event);}"
          />
          <input
            type="checkbox"
            role="switch"
            id="isReverseSwitch"
            :value="getCommonsControlValues().isReverse"
            @change="($event)=>{updateIsReverse($event);}"
          />
          <label class="form-check-label" for="isReverseSwitch"
            >Is reverse</label
          >
        </div>
      </div>
      <div style="flex-grow: 1; display: flex; flex-direction: column">
        <div style="">
          <div>Modulation</div>
          <div style="display: flex; flex-direction: column">xxx</div>
        </div>
        <div style="">
          <div>Filter</div>
          <div style="display: flex; flex-direction: column">xxx</div>
        </div>
      </div>
      <div style="flex-grow: 1">
        <div>Effects</div>
        <div style="display: flex; flex-direction: column">xxx</div>
      </div>
    </div>
    <div
      style="display: flex; flex-direction: row; justify-content: space-evenly"
    >
      <div class="row">
        <div class="col">
          <div class="card border-primary h-100">
            <div class="card-header">
              <div class="btn-group" role="group">
                <button disabled type="button" class="btn btn-outline-primary">
                  <i class="fas fa-hand-spock"></i>
                </button>
                <button disabled type="button" class="btn btn-outline-primary">
                  <i class="fas fa-keyboard"></i>
                </button>
              </div>

              <button disabled type="button" class="btn btn-outline-light">
                Light
              </button>

              <div class="btn-group" role="group">
                <button
                  v-if="machineState.parts[machineState.currentPartIndex].staves>1"
                  @click="($event) => {updateStaveNumber(machineState.parts[machineState.currentPartIndex].staves-1)}"
                  type="button"
                >
                  <i class="fas fa-minus"></i>
                </button>
                <button
                  v-for="n in machineState.parts[machineState.currentPartIndex].staves"
                  @click="($event) => {selectStave(n-1);}"
                  type="button"
                  :class="{ 'btn-primary': machineState.currentStaveIndex == n-1, 'btn-outline-primary': !(machineState.currentStaveIndex == n-1)}"
                >
                  <b>{{n}}</b>
                </button>
                <button
                  @click="($event) => {updateStaveNumber(machineState.parts[machineState.currentPartIndex].staves+1)}"
                  type="button"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="card-text py-2">
                <div role="group">
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(0);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 0}"
                  >
                    D1
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(1);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 1}"
                  >
                    D2
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(2);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 2}"
                  >
                    D3
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(3);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 3}"
                  >
                    D4
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(4);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 4}"
                  >
                    D5
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(5);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 5}"
                  >
                    D6
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(6);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 6}"
                  >
                    D7
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(7);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 7}"
                  >
                    D8
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(8);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 8}"
                  >
                    D9
                  </button>
                  <button
                    @click="($event)=>{selectInstrument(9);}"
                    type="button"
                    :class="{ 'btn-primary': machineState.currentPartInstrumentIndex == 9}"
                  >
                    D10
                  </button>
                  <button disabled type="button" class="btn btn-outline-light">
                    Light
                  </button>
                </div>
              </div>
              <div class="card-text py-2">
                <div role="group">
                  <button
                    v-for="n in 16"
                    @click="($event)=>{toggleInstrumentStep(n-1);}"
                    type="button"
                    :class="{ 'btn-primary': isStepActive(n-1), 'btn-outline-primary': !isStepActive(n-1)}"
                    :disabled="!isStepClickable(n-1)"
                  >
                    <b>{{n}}</b>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function httpGet(path) {
      const response = await fetch(`${path}`);
      const json = await response.json();
      console.log("httpGet res : ", json);
      return json;
    }
    function resizeArray(arr, newSize, defaultValue) {
      return [
        ...arr,
        ...Array(Math.max(newSize - arr.length, 0)).fill(defaultValue),
      ];
    }

    const wsUri = `ws://${window.location.host}/ws`;

    // const allPromises = Promise.all([httpGet("/state")]);

    const { createApp, ref, reactive } = Vue;

    // allPromises.then((allPromisesRet) => {
    createApp({
      setup() {
        const wsStatus = ref(false);

        const machineState = ref({
          masterGain: 0,
          currentModeIndex: 0,
          currentSelectedStepIndex: 0,
          currentSongIndex: 0,
          songName: "NULL song",
          songTempo: 666,
          instruments: [
            {
              sample: {
                filePath: "/data/kick.wav",
                isMono: true,
                fileSize: 9502,
              },
              isSolo: false,
              isMuted: false,
              volume: 0.5,
              pitch: 0,
            },
          ],
          currentPartIndex: 0,
          currentPartInstrumentIndex: 0,
          currentStaveIndex: 0,
          currentOctaveIndex: 0,
          parts: [
            {
              staves: 1,
              steps: [
                [
                  {
                    instrumentIndex: 0,
                    pitch: 0,
                    volume: 0.9,
                  },
                ],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
                [],
              ],
            },
          ],
        });

        const wavFilesList = ref([]);

        const ws = ref(null);

        const httpAction = async function (actionName, actionParameters) {
          const response = await fetch(`/action`, {
            method: "POST",
            body: `${actionName}@${JSON.stringify(actionParameters)}`,
          });
          // const json = await response.json();
          const text = await response.text();
          // console.log("httpAction res : ", json);
          console.log("httpAction res : ", text);
          // TODO : temporary solution for pongs
          sendMessageViaWebsocket("toggle");
          // return json;
        };
        const updateMachineStateRef = async function () {
          const response = await fetch(`/state`);
          const json = await response.json();
          console.log("updateMachineStateRef httpGet res : ", json);
          machineState.value = json;
        };
        const updateWavFilesListRef = async function () {
          const response = await fetch(`/wavFiles`);
          const json = await response.json();
          console.log("updateWavFilesListRef httpGet res : ", json);
          wavFilesList.value = json;
        };
        const connectToWebsocket = function () {
          ws.value = new WebSocket(wsUri);

          ws.value.onopen = () => {
            console.log("connected");
            wsStatus.value = true;
          };

          ws.value.onclose = () => {
            console.log("disconnected");
            wsStatus.value = false;
          };

          ws.value.onmessage = (event) => {
            const message = event.data;
            if (message === "pong") {
              console.log("Pong received !");
            } else {
              console.log("Message received :", message);
              // console.log("Message received as json :", JSON.parse(message));
              // machineState.value = message;
              updateMachineStateRef();
              // updateWavFilesListRef();
            }
          };
        };

        const sendMessageViaWebsocket = function (message) {
          if (!!ws && ws.value.readyState === WebSocket.OPEN) {
            ws.value.send(message);
          } else {
            console.log("WebSocket non connected !");
          }
        };

        // TODO : Refactor to prevent code duplication ( returns and var initialization outside the if statement )
        const getCommonsControlValues = function () {
          if (machineState.value.currentModeIndex == 0) {
            const obj =
              machineState.value.instruments[
                machineState.value.currentPartInstrumentIndex
              ];
            return {
              volume: obj.volume,
              pitch: obj.pitch,
              startPosition: obj.startPosition,
              endPosition: obj.endPosition,
              isReverse: obj.isReverse,
            };
          } else if (machineState.value.currentModeIndex == 1) {
            // console.log(
            //   machineState.value.currentSelectedStepIndex + 16 * machineState.value.currentStaveIndex,
            //   " / ",
            //   machineState.value.parts[
            //     machineState.value.currentPartIndex
            //   ].steps[
            //     machineState.value.currentSelectedStepIndex +
            //       16 * machineState.value.currentStaveIndex
            //   ].find(
            //     (st) =>
            //       st.instrumentIndex ==
            //       machineState.value.currentPartInstrumentIndex
            //   )
            // );
            const obj = machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[
              machineState.value.currentSelectedStepIndex +
                16 * machineState.value.currentStaveIndex
            ].find(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
            return {
              volume: obj.volume,
              pitch: obj.pitch,
              startPosition: obj.startPosition,
              endPosition: obj.endPosition,
              isReverse: obj.isReverse,
            };
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };
        const isStepClickable = function (stepIndex) {
          if (machineState.value.currentModeIndex == 0) {
            return true;
          } else if (machineState.value.currentModeIndex == 1) {
            return machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[stepIndex + 16 * machineState.value.currentStaveIndex].some(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };
        const isStepActive = function (stepIndex) {
          if (machineState.value.currentModeIndex == 0) {
            return machineState.value.parts[
              machineState.value.currentPartIndex
            ].steps[stepIndex + 16 * machineState.value.currentStaveIndex].some(
              (st) =>
                st.instrumentIndex ==
                machineState.value.currentPartInstrumentIndex
            );
          } else if (machineState.value.currentModeIndex == 1) {
            return stepIndex == machineState.value.currentSelectedStepIndex;
          } else if (machineState.value.currentModeIndex == 2) {
            // TODO : implement for fx
            return null;
          } else {
            return null;
          }
        };

        const saveSong = function (modeIndex) {
          // TODO : try it everywhere for actions wiuth no arguments
          // httpAction("SAVESONG");
          httpAction("SAVESONG", {});
        };
        const updateMasterGain = function (event) {
          httpAction("UPDATEMASTERGAIN", Number(event.target.value));
        };
        const updateCurrentMode = function (modeIndex) {
          httpAction("UPDATECURRENTMODE", modeIndex);
        };
        const updateSongName = function (event) {
          httpAction("UPDATESONGNAME", event.target.value);
        };
        const updateTempo = function (event) {
          httpAction("UPDATETEMPO", Number(event.target.value));
        };
        const play = function () {
          httpAction("PLAY", {});
        };
        const stop = function () {
          httpAction("STOP", {});
        };
        const loadPreviousPart = function () {
          httpAction("SELECTPART", machineState.value.currentPartIndex - 1);
        };
        const loadNextPart = function () {
          httpAction("SELECTPART", machineState.value.currentPartIndex + 1);
        };
        const createNextPart = function () {
          httpAction("CREATEPART", {});
        };
        const updateStaveNumber = function (staveNumber) {
          httpAction("UPDATESTAVENUMBER", staveNumber);
        };
        const selectStave = function (staveIndex) {
          httpAction("SELECTSTAVE", staveIndex);
        };
        const selectInstrument = function (instrumentIndex) {
          httpAction("SELECTINSTRUMENT", instrumentIndex);
        };
        const getPreviousSample = function () {
          const currentFilePath =
            machineState.value.instruments[
              machineState.value.currentPartInstrumentIndex
            ].sample.filePath;
          const currentFileIndex = wavFilesList.value.indexOf(currentFilePath);
          console.log("bouya", currentFileIndex);
          if (currentFileIndex - 1 >= 0) {
            console.log("kasha");
            updateSelectedInstrumentSample(currentFileIndex - 1);
          }
        };
        const getNextSample = function () {
          const currentFilePath =
            machineState.value.instruments[
              machineState.value.currentPartInstrumentIndex
            ].sample.filePath;
          const currentFileIndex = wavFilesList.value.indexOf(currentFilePath);
          console.log("bouya", currentFileIndex, wavFilesList.value.length);
          if (currentFileIndex + 1 <= wavFilesList.value.length - 1) {
            console.log("kasha");
            updateSelectedInstrumentSample(currentFileIndex + 1);
          }
        };
        const updateSelectedInstrumentSample = function (sampleIndex) {
          httpAction("UPDATESELECTEDINSTRUMENTSAMPLE", sampleIndex);
        };
        const toggleInstrumentStep = function (stepIndex) {
          const stepIndexToUpdate =
            stepIndex + 16 * machineState.value.currentStaveIndex;
          if (machineState.value.currentModeIndex == 0) {
            httpAction("TOGGLEINSTRUMENTSTEP", stepIndexToUpdate);
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction("UPDATECURRENTSELECTEDSTEP", stepIndexToUpdate);
          }
        };

        const updateVolume = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEVOLUME",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPVOLUME",
              Number(event.target.value)
            );
          }
        };

        const updatePitch = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEPITCH",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPPITCH",
              Number(event.target.value)
            );
          }
        };

        const updateStartPosition = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTARTPOSITION",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPSTARTPOSITION",
              Number(event.target.value)
            );
          }
        };

        const updateEndPosition = function (event) {
          if (machineState.value.currentModeIndex == 0) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLEENDPOSITION",
              Number(event.target.value)
            );
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction(
              "UPDATEINSTRUMENTSAMPLESTEPENDPOSITION",
              Number(event.target.value)
            );
          }
        };

        const updateIsReverse = function (event) {
          // console.log(
          //   "updateIsReverse event.target.checked : ",
          //   event.target.checked
          // );
          const isChecked = event.target.checked ? 1 : 0;
          if (machineState.value.currentModeIndex == 0) {
            httpAction("UPDATEINSTRUMENTSAMPLEISREVERSE", isChecked);
          } else if (machineState.value.currentModeIndex == 1) {
            httpAction("UPDATEINSTRUMENTSAMPLESTEPISREVERSE", isChecked);
          }
        };

        updateMachineStateRef().then((_) => {
          connectToWebsocket();
        });

        updateWavFilesListRef();

        return {
          wsStatus,
          machineState,
          wavFilesList,
          connectToWebsocket,
          sendMessageViaWebsocket,
          saveSong,
          updateMasterGain,
          updateCurrentMode,
          updateSongName,
          updateTempo,
          play,
          stop,
          loadPreviousPart,
          loadNextPart,
          createNextPart,
          updateStaveNumber,
          selectStave,
          selectInstrument,
          getPreviousSample,
          getNextSample,
          updateSelectedInstrumentSample,
          getCommonsControlValues,
          isStepClickable,
          isStepActive,
          toggleInstrumentStep,
          updateTempo,
          updateVolume,
          updatePitch,
          updateStartPosition,
          updateEndPosition,
          updateIsReverse,
        };
      },
    }).mount("#app");
    // });
  </script>
</body>
